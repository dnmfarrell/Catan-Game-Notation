=pod

=encoding utf8

=head1 Settlers Game Notation

This document defines a notation for the game island colonization game Settlers, called "Settlers Game Notation" (SGN). SGN is represented as JSON and is designed to capture "what happened" for a game of Settlers.

=head2 Goal

As far as this author is aware, there is no formal, public and free notation for Settlers. This document aims to establish a common language for recording games of Settlers that can be used to implement Settlers software components like games, clients, servers and AI.

=head2 Status

This is a working draft of the SGN spec, and all feedback is welcome. The spec is expected to be finalized in the first quarter of 2016.

=head2 JSON Schema

The F<schema/message.json> file is a draft schema for an SGN message (work-in-progress).

=head2 Examples

Examples of SGN will be available in the F<examples/> directory.

=head2 Definition

A valid SGN document is an array of Messages. The idea is to capture the entirety of a game of Settlers from setup to end. The order of messages is always sequential: an SGN document could describe just the game setup for example. But it couldn't describe the deployment phase unless the setup phase is also defined earlier in the same document.

=head2 Messages

Every event in a game of Settlers is described in a message format. A message is a JSON object with the following properties:

  Name    Value
  ------------------------------------------------------------------------------
  uuid    Universally Unique IDentifier, used to identify individual game events
  player  The player # (or "A" for admin if it came from the server)
  event   The two letter event code (see Events below)
  value   The value associated with the event code (see Events below)
  batch   The sequence number of the message e.g. message 1 of 2 is: [1,2]

C<batch> is an optional property. An example admin message for declaring player 2 has joined the game:

  {
    "uuid": "1C68D574-937F-11E5-AF19-C9E87C9D2E84",
    "player": "A",
    "event": "PA",
    "value": {"player": "2"},
  }

Here is a batch of two messages ending the round and the deployment phase:

  {
    "uuid": "1C68D574-937F-11E5-AF19-C9E87C9D2E84",
    "player": "A",
    "event": "RE",
    "value": {"round":2},
    "batch": [1,2]
  }
  {
    "uuid": "1C68D574-937F-11E5-AF19-C9E87C9D2E84",
    "player": "A",
    "event": "PE",
    "value": {"phase": "Deployment"},
    "batch": [2,2]
  }

Batching is useful for implementation: a client doesn't have to redraw the screen until it has finished processing an entire batch of messages, rather than redrawing the screen everytime it processes a single message.

=head2 Hexes

All hexes (tiles) are numbered, including sea tiles, using the axial (trapezoidal) coordinate system:

             0,-3  1,-3  2,-3   3,-3
         -1,-2  0,-2  1,-2   2,-2   3,-2
     -2,-1  -1,-1  0,-1   1,-1   2,-1   3,-1
  -3,0   -2,0   -1,0    0,0    1,0    2,0    3,0
     -3,1   -2,1   -1,1   0,1    1,1    2,1
        -3,2   -2,2   -1,2  0,2    1,2
           -3,3   -2,3   -1,3  0,3

This is the same map with the sea tiles represented by tildes (incorrect notation but easier to interpret visually):

           ~~~~  ~~~~  ~~~~   ~~~~
        ~~~~ 0,-2   1,-2   2,-2  ~~~~
     ~~~~  -1,-1  0,-1  1,-1  2,-1  ~~~~
  ~~~~  -2,0   -1,0   0,0   1,0   2,0  ~~~~
     ~~~~  -2,1   -1,1   0,1   1,1  ~~~~
        ~~~~  -2,2   -1,2   0,2  ~~~~
           ~~~~   ~~~~   ~~~~  ~~~~

Hex notation is used to define the layout of the board tiles and the location of the robber.

=head2 Tile Types

A tile can be any one of the below:

  Code Type
  --------------
  H    Hills
  D    Desert
  M    Mountains
  S    Sea
  F    Fields
  FO   Forest
  P    Pastures

=head2 Resource Number

A tile can have one resource number on it, valid numbers are between 2-6 and 8-12. There is also a limit on the frequency of resource numbers. These are all the available resource numbers for a basic game:

  2,3,3,4,4,5,5,6,6,8,8,9,9,10,10,11,11,12

=head2 Tile Notation

A tile is defined by its hex coordinates, type code and resource number. This is a central desert tile:

  {
    tile: [0,0],
    tCode: "D",
    "rNumber": null
  }

=head2 Intersections

Intersections represent a point between 3 hex locations in a clockwise order. Intersections are represented as an array of 3 hex locations. E.g. the six intersections of the center hex on the starter map layout:

                 [[0,-1],[0,0],[-1,0]]
                         /   \
  [[0,-1],[0,0],[-1,0]] /     \  [[1,-1],[1,0],[0,0]]
                       |  0,0  |
                       |       |
  [[0,0],[-1,1],[-1,0]] \     /  [[1,0],[0,1],[0,0]]
                         \   /
                 [[0,1],[-1,1],[0,0]]


Intersections are used to define the location of settlements and cities.

=head2 Paths

Paths are lines between contiguous intersections and are represented as an array of intersections. Each path must have at least two intersections:

  [ [[0,0],[-1,1],[-1,0]], [[0,1],[-1,1],[0,0]] ]

Paths are used to define where harbors and roads are placed.

=head2 Harbors

Harbors are placed on paths adjacent to sea tiles. There are 6 harbor types:

  Code  Type
  --------------------
  HR    Generic Harbor
  HRB   Brick Harbor
  HRG   Grain Harbor
  HRL   Lumber Harbor
  HRO   Ore Harbor
  HRW   Wool Harbor

Typical maps will have 4 generic harbors and 1 of every other kind.

=head2 Defining the map

Every tile is listed with its coordinates, type code and resource number. C<null> represents no resource number. Harbors are declared at path locations with the harbor type code. A starter map layout:

  {
    "tiles": [
      {"tile":[0,-3],"tCode":"S","rNumber":null},
      {"tile":[1,-3],"tCode":"S","rNumber":null},
      {"tile":[2,-3],"tCode":"S","rNumber":null},
      {"tile":[3,-3],"tCode":"S","rNumber":null},
      {"tile":[3,-2],"tCode":"S","rNumber":null},
      {"tile":[3,-1],"tCode":"S","rNumber":null},
      {"tile":[3,0],"tCode":"S","rNumber":null},
      {"tile":[2,1],"tCode":"S","rNumber":null},
      {"tile":[1,2],"tCode":"S","rNumber":null},
      {"tile":[0,3],"tCode":"S","rNumber":null},
      {"tile":[-1,3],"tCode":"S","rNumber":null},
      {"tile":[-2,3],"tCode":"S","rNumber":null},
      {"tile":[-3,3],"tCode":"S","rNumber":null},
      {"tile":[-3,2],"tCode":"S","rNumber":null},
      {"tile":[-3,1],"tCode":"S","rNumber":null},
      {"tile":[-3,0],"tCode":"S","rNumber":null},
      {"tile":[-2,-1],"tCode":"S","rNumber":null},
      {"tile":[-1,-2],"tCode":"S","rNumber":null},
      {"tile":[1,-2],"tCode":"P","rNumber":12},
      {"tile":[2,-2],"tCode":"F","rNumber":9},
      {"tile":[2,-1],"tCode":"P","rNumber":10},
      {"tile":[2,0],"tCode":"F","rNumber":8},
      {"tile":[1,1],"tCode":"M","rNumber":3},
      {"tile":[0,2],"tCode":"FO","rNumber":6},
      {"tile":[-1,2],"tCode":"F","rNumber":2},
      {"tile":[-2,2],"tCode":"M","rNumber":5},
      {"tile":[-2,1],"tCode":"H","rNumber":8},
      {"tile":[-2,0],"tCode":"D",null},
      {"tile":[-1,-1],"tCode":"H","rNumber":4},
      {"tile":[0,-1],"tCode":"M","rNumber":6},
      {"tile":[1,-1],"tCode":"H","rNumber":5},
      {"tile":[1,0],"tCode":"FO","rNumber":4},
      {"tile":[0,1],"tCode":"P","rNumber":9},
      {"tile":[-1,1],"tCode":"P","rNumber":10},
      {"tile":[-1,0],"tCode":"FO","rNumber":3},
      {"tile":[0,0],"tCode":"F","rNumber":11}
    ],
    "harbors": [
      {"path":[[[0,-3],[0,-2],[-1,-2]],  [[1,-3],[0,-2],[0,-3]]],   "hCode": "HR"},
      {"path":[[[2,-3],[1,-2],[1,-3]],   [[2,-3],[2,-2],[1,-2]]],   "hCode": "HRW"},
      {"path":[[[3,-2],[2,-1],[2,-2]],   [[3,-2],[3,-1],[2,-1]]],   "hCode": "HR"},
      {"path":[[[3,-1],[3,0],[2,0]],     [[3,0],[2,1],[2,0]]],      "hCode": "HR"},
      {"path":[[[2,1],[1,2],[1,1]],      [[1,1],[1,2],[0,2]]],      "hCode": "HRB"},
      {"path":[[[0,2],[-1,3],[-1,2]],    [[-1,2],[-1,3],[-2,3]]],   "hCode": "HRL"},
      {"path":[[[-2,2],[-2,3],[-3,3]],   [[-2,2],[-3,3],[-3,2]]],   "hCode": "HR"},
      {"path":[[[-2,1],[-3,2],[-3,1]],   [[-2,0],[-2,1],[-3,1]]],   "hCode": "HRG"},
      {"path":[[[-1,-1],[-2,0],[-2,-1]], [[-1,-2],[-1,-1],[-2,-1]]],"hCode": "HRO"}
    ]
  }

=head2 Resources

There are 5 types of resources:

  Code  Type
  ------------
  B     Brick
  G     Grain
  L     Lumber
  O     Ore
  W     Wool

=head2 Resources notation

Resources notation records which resources and in what quantity are being traded by players with the bank or with each other.

It uses the resource code as the key and the value as the quantity. Both quantities gained and lost are listed. So a trade between player 1 and player 2 for 2 lumber for a wool looks like:

  [
    {"player":"1","L":-2,"W": 1},
    {"player":"2","L": 2,"W":-1}
  ]

The implication of this notation is that all resources must balance. For trades with the bank, C<B> represents the bank. Here is a bank trade by player 2, losing 4 grain to get a brick:

  [
    {"player":"2",    "G":-4,"B": 1},
    {"player":"B", "G": 4,"B":-1}
  ]

Resource notation isn't just for trades. It's used for gains from resource production, stealing resources with the robber and conceding resources back to the
bank.

=head2 Assets

Players may accumulate these throughout the game. There are four normal and two special types:

  Code  Name              How to get it
  ---------------------------------------------------------
  DC    Development card  Build development card event (BD)
  S     Settlement        Build settlement event (BS)
  C     City              Build city event (BC)
  R     Road              Build road event (BR)
  LA    Largest army      Largest Army event
  LR    Longest road      Longest Road event

There are 5 types of development cards:

  Code  Name
  -------------------
  KN    Knight
  MO    Monopoly
  RB    Road building
  VP    Victory Point
  YP    Year of plenty

=head2 Events

Events are the things which drive the game: player actions, dice rolls etc. Every entry in SGN is an event, consisting of an event code and a JSON value. Refer to F<example.json> for examples of these events in SGN.

  Code Name                    Value
  --------------------------------------------------------------------------------------
  BC   Build city              {"intersection":<intersection coordinates>}
  BD   Build development card  {"cCode": "KN|MO|RB|VP|YP"}
  BR   Build road              {"path":<path coordinates>}
  BS   Build settlement        {"intersection":<intersection coordinates>}
  CH   Chat                    {"msg": "msg text"}
  CR   Concede resources       {"resources":<resource notation>}
  DR   Dice roll               {"result":#}
  GO   Game Over               {}
  LA   Largest army            {"strength":#}
  LR   Longest road            {"length":#}
  MD   Map Define              {"tiles":[...], "harbors":[..]}
  MO   Monopoly                {"resources":<resource notation>}
  PA   Player Add              {"player": "#"}
  PD   Play development card   {"code": "KN|MO|RB|VP|YP"}
  PE   Phase End               {"phase": "Setup|Deployment|Play|End"}
  PS   Phase Start             {"phase": "Setup|Deployment|Play|End"}
  RA   Robber activate         {}
  RD   Robber deactivate       {}
  RE   Round End               {"round": #}
  RM   Robber move             {"tile": <tile coordinates>}
  RP   Resource Production     {"resources": <resource notation> }
  RR   Robber rob              {"resources": <resource notation> }
  RS   Round Start             {"round": #}
  TA   Trade accept            {"uuid":"#"}
  TB   Trade bank              {"resources":<resource notation>}
  TC   Trade cancel            {"uuid":"#"}
  TD   Trade decline           {"uuid":"#"}
  TE   Turn End                {}
  TO   Trade offer             {"resources":<resource notation>}
  TR   Trade resources         {"uuid":"#", "resources":<resource notation>}
  TS   Turn Start              {}
  YP   Year of plenty          {"resources":<resource notation>}

=head2 Trading

Trading is a big part of Settlers. Players may trade with each other or with the Bank.

Bank trades are described using the trade bank event. For example, here's a complete bank trade message:

  {
    "event": "TB",
    "value":{
      "resources":[{"player":"B","B":"-1","O":"4"},{"player":"2","B":"1","O":"-4"}]
    }
    "uuid":"#",
    "player":"2"
  }

Player trades have two parts: offer and acceptance. A Player may offer a trade to other players with resource notation and a universal unique id (uuid).

The trade offer can be ended with:

=over 4

=item * Trade cancel

The offering player cancels the offer using the trade cancel event.

=item * Trade decline

The receiving player declines the offer using the trade decline event.

=item * Trade accept

The other player accepts the trade offer using the trade accept event.

=item * End turn

If a player's turn ends, all outstanding trade offers are cancelled. No Trade Cancel events are issued for this.

=back

Here is an example trade between player 1 and player 2:

  {
    "event":"TO",
    "player":"1",
    "value": {"resources":[{"player":"1","B":-2,"W":1},{"player":"2","B":2,"W":-1}]},
    "uuid":"1234-56789-01234"
  },
  {
    "event":"TA",
    "player":"2",
    "value": {"uuid":"1234-56789-01234"},
    "uuid": "#"
  },
  {
    "event":"TR",
    "player":"A",
    "value":{"resources":[{"player":"1","B":-2,"W":1},{"player":"3","B":2,"W":-1}]},
    "uuid": "#"
  }

The exchange begins with a Trade offer from player 1 for 1 wool in exchange for 2 brick to player 2. Player 2 accepts the offer, and this triggers the Trade event.

=head2 Chat

Player chat uses the event code C<CH>. It provides a key/pair of the player name and the chat text. Here's a conversation:

  {
    "event": "CH",
    "player": "1",
    "uuid": "#",
    "value":{"msg":"Let's do this!"},
  },
  {
    "event": "CH",
    "player": "2",
    "uuid": "#",
    "value":{"msg":"I'm gonna get you!"},
  }

Chat is not necessary for game notation, but helps with the implementation of a game server using game notation. Server or referee chat messages have the player id C<A> for admin.

=head2 Phases

=over 4

=item 1 Setup

Setup involves adding players and defining the map. The first event in every game log should be to start the Setup phase.

=item 2 Deployment

Players can deploy settlements and roads in the deployment phase according to the rules of Settlers. Player 1 always goes first.

=item 3 Play

This is the regular Settlers play action.

=item 4 End

The game is over as a player has won.

=back

=head2 Rounds

A round is one cycle of every player's turn. The Deployment phase has 2 rounds and the Play phase has as many rounds as required to end the game.

=head2 Turns

During the Deployment phase, a player must build a settlement and a road, then their turn ends. No other actions during Deployment are permitted. Player 1 always goes first, then player 2, and so on. When the last player has completed their first Deployment phase turn, the turn sequence then reverses so that the last player immediately gets another Deployment phase turn. Deployment is over when the first player has deployed two settlements and two roads.

During the Play phase, the turn sequence begins with Player 1. They may play a development card. The next action they must take is to roll the dice. After the dice roll has been resolved, they may offer and received trade offers from other players and they can build assets. Once player 1 ends their turn, player 2 will have the next turn and so on.

=head2 Players

Players are just string identifiers that refer to a player of the game, an administrator/referee or the bank. The examples in this document refer to players by stringified numbers like C<"1">, but this is not necessary. The string must be unique identifier for the player, so it's fine to use a name instead: C<"David">.

Two player names are special and reserved: C<"B"> refers to the banker and C<"A"> refers to the administrator, server or refereee of the game.

=head1 FAQ

=over 4

=item * I<Is SGN case-sensitive?> YES!

=item * I<Why is there no Road Building event?> There is no need for it. When the Play Development card event occurs with a type code of C<RB> that indicates road building is active. The player can then build roads using the build road event.

=back

=head2 See Also

L<Settlers-Game|https://github.com/dnmfarrell/Settlers-Game> is my attempt to implement a Settlers game class using SGN.

L<Pioneers|http://pio.sourceforge.net/> an open source implementation of the island colonization game.

L<Catan|http://playcatan.com> the official website for Settlers of Catan.

=head2 Version

0.03

=head2 Changes

=head3 0.03 2015-12-17

Messages can include a batch value. Added the trade decline event. Changed the definition of tiles and harbors to be objects rather than arrays. Resource notation is now an array of objects that include a player property. Removed C<player> from every event value, except for Player Add (it was redundant). Types of things are identified by new names: C<tCodes> for tile codes, C<hCodes> for harbor codes and C<cCodes> for development card codes.

=head3 0.02 2015-11-25

Ports are declared on paths instead of tiles. SGN messages have event code, value, sender and UUID attributes.

=head3 0.01 2015-11-20

Initial release

=head2 Author

David Farrell, E<copy> 2015.

=head2 License

FreeBSD, see LICENSE

=cut
